#include QMK_KEYBOARD_H

extern keymap_config_t keymap_config;

#define _BASE 0
#define _SYMBOL 1
#define _NAVIGATION 2
#define _ENCLR 3
#define _ENCUD 4
#define _RGB 5

enum custom_keycodes {
  QWERTY = SAFE_RANGE,
  SYMBOL
};

enum {
  TD_ENC = 0,
  TD_GRV,
  TD_CTRL,
  TD_ALT,
  TD_SLCK
};

typedef struct {
  bool is_press_action;
  int state;
} tap;

enum {
  SINGLE_TAP = 1,
  SINGLE_HOLD = 2,
  DOUBLE_TAP = 3
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

  [_BASE] = LAYOUT(
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
      KC_ESC,     KC_1,      KC_2,      KC_3,      KC_4,      KC_5,                                  KC_6,      KC_7,      KC_8,      KC_9,      KC_0,    KC_DEL,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
      KC_TAB,     KC_Q,      KC_W,      KC_E,      KC_R,      KC_T,                                  KC_Y,      KC_U,      KC_I,      KC_O,      KC_P,    KC_BSLS,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
      KC_LSFT,    KC_A,      KC_S,      KC_D,      KC_F,      KC_G,                                  KC_H,      KC_J,      KC_K,      KC_L,     KC_SCLN,  KC_QUOT,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
      KC_LGUI,    KC_Z,      KC_X,      KC_C,      KC_V,      KC_B,   TD(TD_ENC),      TD(TD_GRV),   KC_N,      KC_M,    KC_COMM,    KC_DOT,    KC_SLSH, TG(_SYMBOL),
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
                                          TD(TD_CTRL), KC_SPC,  TD(TD_ALT),                   KC_BSPC,   KC_ENT,   TD(TD_SLCK)
  //                                      \----------+----------+----------/                \----------+----------+----------/
  ),

  [_SYMBOL] = LAYOUT(
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
      KC_F1,     KC_F2,     KC_F3,     KC_F4,     KC_F5,     KC_F6,                                  KC_F7,     KC_F8,     KC_F9,    KC_F10,    KC_F11,    KC_F12,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               KC_EQL,    KC_AMPR,   KC_PIPE,   KC_EXLM,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               KC_SLSH,   KC_LBRC,   KC_RBRC,   KC_BSLS,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,   _______,         _______,   _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
                                            _______,   _______,   _______,                    _______,   _______,   _______
  //                                      \----------+----------+----------/                \----------+----------+----------/
  ),

  [_NAVIGATION] = LAYOUT(
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,     KC_F5,     KC_F6,                               _______,     KC_7,      KC_8,      KC_9,    KC_SLSH,   KC_EQL,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,    KC_UP,    _______,   KC_PGUP,   KC_HOME,                               _______,     KC_4,      KC_5,      KC_6,    KC_ASTR,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   KC_LEFT,   KC_DOWN,   KC_RGHT,   KC_PGDN,   KC_END,                                _______,     KC_1,      KC_2,      KC_3,    KC_PLUS,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,   _______,         _______,   _______,     KC_0,     KC_DOT,   _______,   KC_MINS,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
                                            _______,   _______,   _______,                    _______,   _______,   _______
  //                                      \----------+----------+----------/                \----------+----------+----------/
  ),

  [_ENCLR] = LAYOUT(
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,   _______,         _______,   _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
                                            _______,   _______,   _______,                    _______,   _______,   _______
  //                                      \----------+----------+----------/                \----------+----------+----------/
  ),

  [_ENCUD] = LAYOUT(
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
     _______,   _______,   _______,   _______,   _______,   _______,   _______,         _______,   _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
                                            _______,   _______,   _______,                    _______,   _______,   _______
  //                                      \----------+----------+----------/                \----------+----------+----------/
  ),

  [_RGB] = LAYOUT(
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     RGB_TOG,   BL_STEP,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     RGB_MOD,   _______,   _______,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+                            ----------+----------+----------+----------+----------+----------+
     RGB_HUI,   RGB_SAI,   RGB_VAI,   _______,   _______,   _______,                               _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
     RGB_HUD,   RGB_SAD,   RGB_VAD,   _______,   _______,   _______,   _______,         _______,   _______,   _______,   _______,   _______,   _______,   _______,
  //----------+----------+----------+----------+----------+----------+----------+      ----------+----------+----------+----------+----------+----------+----------+
                                            _______,   _______,   _______,                    _______,   _______,   _______
  //                                      \----------+----------+----------/                \----------+----------+----------/
  ),
};

// bool process_record_user(uint16_t keycode, keyrecord_t *record) {
//   switch (keycode) {
//       case SYMBOL:
//         if (record->event.pressed) {
//             if (layer_state_is(_SYMBOL)) {
//                 //if already set, then switch it off
//                 layer_off(_SYMBOL);
//             } else {
//                 //if not already set, then switch the layer on
//                 layer_on(_SYMBOL);
//             }
//         }
//         return false;
//         break;
//   }
//   return true;
// };

//Determine the current tap dance state
int cur_dance (qk_tap_dance_state_t *state) {
  if (state->count == 1) {
    if (!state->pressed) {
      return SINGLE_TAP;
    } else {
      return SINGLE_HOLD;
    }
  } else if (state->count == 2) {
    return DOUBLE_TAP;
  }
  else return 8;
}

//Initialize tap structure associated with example tap dance key
static tap ql_tap_state = {
  .is_press_action = true,
  .state = 0
};

void encoder_tap (qk_tap_dance_state_t *state, void *user_data) {
    if (state->count == 1) {
        if (layer_state_is(_ENCUD)) {
            //if already set, then switch it off
            layer_off(_ENCUD);
        } else {
            //if not already set, then switch the layer on
            layer_on(_ENCUD);
        }
    } else if (state->count == 2) {
        if (layer_state_is(_ENCLR)) {
            //if already set, then switch it off
            layer_off(_ENCLR);
        } else {
            //if not already set, then switch the layer on
            layer_on(_ENCLR);
        }
    }
}

void grv_tap (qk_tap_dance_state_t *state, void *user_data) {
    if (state->count == 1) {
        //send ` to the computer unless we're on the RGB layer. Turn off RGB layer if it's active
        if (layer_state_is(_RGB)) {
            layer_off(_RGB);
        } else {
            tap_code(KC_GRV);
        }
    } else if (state->count == 2) {
        if (layer_state_is(_NAVIGATION)) {
            //if already set, then switch it off
            layer_off(_NAVIGATION);
        } else {
            //if not already set, then switch the layer on
            layer_on(_NAVIGATION);
        }
    } else if (state->count == 4) {
        //I've confused myself and need to reset the layers
        layer_off(_SYMBOL);
        layer_off(_NAVIGATION);
        layer_off(_ENCLR);
        layer_off(_ENCUD);
    } else if (state->count == 7) {
        //Activate RGB layer
        layer_on(_RGB);
    }
}

void ctrl_dance_finish (qk_tap_dance_state_t *state, void *user_data) {
  ql_tap_state.state = cur_dance(state);
  switch (ql_tap_state.state) {
    case SINGLE_TAP:
      register_code(KC_LSFT);
      tap_code(KC_LBRC);
      unregister_code(KC_LSFT);
      break;
    case SINGLE_HOLD:
      register_code(KC_LCTRL);
      break;
    case DOUBLE_TAP:
      tap_code(KC_LBRC);
      break;
  }
}

void ctrl_dance_reset (qk_tap_dance_state_t *state, void *user_data) {
  unregister_code (KC_LCTRL);
  ql_tap_state.state = 0;
}

void alt_dance_finish (qk_tap_dance_state_t *state, void *user_data) {
  ql_tap_state.state = cur_dance(state);
  switch (ql_tap_state.state) {
    case SINGLE_TAP:
      register_code(KC_LSFT);
      tap_code(KC_RBRC);
      unregister_code(KC_LSFT);
      break;
    case SINGLE_HOLD:
      register_code(KC_LALT);
      break;
    case DOUBLE_TAP:
      tap_code(KC_RBRC);
      break;
  }
}

void alt_dance_reset (qk_tap_dance_state_t *state, void *user_data) {
  unregister_code (KC_LALT);
  ql_tap_state.state = 0;
}

qk_tap_dance_action_t tap_dance_actions[] = {
    [TD_ENC]    = ACTION_TAP_DANCE_FN(encoder_tap),
    [TD_GRV]    = ACTION_TAP_DANCE_FN(grv_tap),
    [TD_CTRL]   = ACTION_TAP_DANCE_FN_ADVANCED(NULL, ctrl_dance_finish, ctrl_dance_reset),
    [TD_ALT]    = ACTION_TAP_DANCE_FN_ADVANCED(NULL, alt_dance_finish, alt_dance_reset),
    [TD_SLCK]   = ACTION_TAP_DANCE_DOUBLE(KC_RSFT, KC_CAPS)
};

void encoder_update_user(uint8_t index, bool clockwise) {
    if (index == _BASE) {
        if (clockwise) {
            tap_code(KC_WH_D);
        } else {
            tap_code(KC_WH_U);
        }
    }
    else if (index == _ENCUD) {
        if (clockwise) {
            tap_code(KC_DOWN);
        } else {
            tap_code(KC_UP);
        }
    }
    else if (index == _ENCLR) {
        if (clockwise) {
            tap_code(KC_RGHT);
        } else {
            tap_code(KC_LEFT);
        }
    }
}
